// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =======================
// ENUMS
// =======================

enum UserRole {
  STUDENT
  TUTOR
  STAFF
  ADMIN
}

enum UserStatus {
  ACTIVE
  DEACTIVATED
  PENDING
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BookingStatus {
  PENDING
  ACCEPTED
  COMPLETED
  CANCELLED
}

enum EscrowStatus {
  HELD
  RELEASED
  REFUNDED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  PAYMENT
  FEE
  REFUND
}

enum TutoringMode {
  VIRTUAL
  IN_PERSON
  BOTH
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum ComplaintStatus {
  OPEN
  IN_REVIEW
  RESOLVED
  CLOSED
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

// =======================
// USER & AUTH
// =======================

model User {
  id            String      @id @default(cuid())
  email         String      @unique
  passwordHash  String      @map("password_hash")
  role          UserRole
  status        UserStatus  @default(PENDING)
  emailVerified DateTime?   @map("email_verified")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  studentProfile StudentProfile?
  tutorProfile   TutorProfile?
  wallet         Wallet?
  sessions       Session[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// =======================
// STUDENT PROFILE
// =======================

model StudentProfile {
  id           String   @id @default(cuid())
  userId       String   @unique @map("user_id")
  fullName     String   @map("full_name")
  phone        String?
  gradeLevel   String?  @map("grade_level")
  locationCity String?  @map("location_city")
  locationArea String?  @map("location_area")
  avatar       String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings Booking[]
  reviews  Review[]

  @@map("student_profiles")
}

// =======================
// TUTOR PROFILE
// =======================

model TutorProfile {
  id                 String             @id @default(cuid())
  userId             String             @unique @map("user_id")
  fullName           String             @map("full_name")
  phone              String?
  bio                String?            @db.Text
  hourlyRate         Decimal            @map("hourly_rate") @db.Decimal(10, 2)
  gender             Gender?
  locationCity       String?            @map("location_city")
  locationArea       String?            @map("location_area")
  tutoringMode       TutoringMode       @default(BOTH) @map("tutoring_mode")
  verificationStatus VerificationStatus @default(PENDING) @map("verification_status")
  rejectionReason    String?            @map("rejection_reason") @db.Text
  rating             Decimal?           @db.Decimal(3, 2)
  totalReviews       Int                @default(0) @map("total_reviews")
  isLocked           Boolean            @default(false) @map("is_locked")
  avatar             String?
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  user               User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  subjects           TutorSubject[]
  availability       Availability[]
  verificationDocs   TutorVerificationDoc[]
  bookings           Booking[]
  reviews            Review[]
  classroomResources ClassroomResource[]

  @@index([verificationStatus])
  @@index([rating])
  @@map("tutor_profiles")
}

model TutorVerificationDoc {
  id        String   @id @default(cuid())
  tutorId   String   @map("tutor_id")
  docType   String   @map("doc_type") // 'university_id', 'transcript', 'profile_photo'
  fileUrl   String   @map("file_url")
  fileName  String   @map("file_name")
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  tutor TutorProfile @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@index([tutorId])
  @@map("tutor_verification_docs")
}

// =======================
// SUBJECTS
// =======================

model Subject {
  id       String  @id @default(cuid())
  name     String  @unique
  category String?
  icon     String?

  tutors TutorSubject[]

  @@map("subjects")
}

model TutorSubject {
  id        String   @id @default(cuid())
  tutorId   String   @map("tutor_id")
  subjectId String   @map("subject_id")
  createdAt DateTime @default(now()) @map("created_at")

  tutor   TutorProfile @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  subject Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([tutorId, subjectId])
  @@index([tutorId])
  @@index([subjectId])
  @@map("tutor_subjects")
}

// =======================
// AVAILABILITY
// =======================

model Availability {
  id        String    @id @default(cuid())
  tutorId   String    @map("tutor_id")
  dayOfWeek DayOfWeek @map("day_of_week")
  startTime String    @map("start_time") // Format: "HH:MM"
  endTime   String    @map("end_time") // Format: "HH:MM"
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")

  tutor TutorProfile @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@index([tutorId])
  @@index([dayOfWeek])
  @@map("availability")
}

// =======================
// WALLET & TRANSACTIONS
// =======================

model Wallet {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  balance   Decimal  @default(0) @db.Decimal(10, 2)
  currency  String   @default("ETB")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("wallets")
}

model Transaction {
  id              String          @id @default(cuid())
  walletId        String          @map("wallet_id")
  type            TransactionType
  amount          Decimal         @db.Decimal(10, 2)
  balanceAfter    Decimal         @map("balance_after") @db.Decimal(10, 2)
  description     String?
  referenceId     String?         @map("reference_id") // booking_id or external payment ID
  paymentGateway  String?         @map("payment_gateway") // 'chapa', 'telebirr'
  paymentMetadata Json?           @map("payment_metadata")
  createdAt       DateTime        @default(now()) @map("created_at")

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([type])
  @@index([referenceId])
  @@map("transactions")
}

// =======================
// BOOKINGS
// =======================

model Booking {
  id           String        @id @default(cuid())
  studentId    String        @map("student_id")
  tutorId      String        @map("tutor_id")
  subjectName  String        @map("subject_name")
  scheduledFor DateTime      @map("scheduled_for")
  duration     Int // in minutes
  status       BookingStatus @default(PENDING)
  totalAmount  Decimal       @map("total_amount") @db.Decimal(10, 2)
  platformFee  Decimal       @map("platform_fee") @db.Decimal(10, 2)
  tutorEarning Decimal       @map("tutor_earning") @db.Decimal(10, 2)
  escrowStatus EscrowStatus  @default(HELD) @map("escrow_status")
  
  // Completion tracking
  completedByTutor   Boolean?  @default(false) @map("completed_by_tutor")
  completedByStudent Boolean?  @default(false) @map("completed_by_student")
  completedAt        DateTime? @map("completed_at")
  
  notes       String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  student   StudentProfile      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tutor     TutorProfile        @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  classroom Classroom?
  complaint Complaint?
  review    Review?

  @@index([studentId])
  @@index([tutorId])
  @@index([status])
  @@index([scheduledFor])
  @@map("bookings")
}

// =======================
// CLASSROOM
// =======================

model Classroom {
  id          String   @id @default(cuid())
  bookingId   String   @unique @map("booking_id")
  meetingLink String?  @map("meeting_link")
  meetingId   String?  @map("meeting_id")
  createdAt   DateTime @default(now()) @map("created_at")

  booking   Booking             @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  resources ClassroomResource[]

  @@map("classrooms")
}

model ClassroomResource {
  id          String   @id @default(cuid())
  classroomId String   @map("classroom_id")
  tutorId     String   @map("tutor_id")
  title       String
  description String?  @db.Text
  resourceType String  @map("resource_type") // 'file', 'link', 'text'
  fileUrl     String?  @map("file_url")
  content     String?  @db.Text
  uploadedAt  DateTime @default(now()) @map("uploaded_at")

  classroom Classroom    @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  tutor     TutorProfile @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@index([classroomId])
  @@index([tutorId])
  @@map("classroom_resources")
}

// =======================
// REVIEWS & COMPLAINTS
// =======================

model Review {
  id        String   @id @default(cuid())
  bookingId String   @unique @map("booking_id")
  studentId String   @map("student_id")
  tutorId   String   @map("tutor_id")
  rating    Int // 1-5
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  booking Booking        @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tutor   TutorProfile   @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@index([tutorId])
  @@index([rating])
  @@map("reviews")
}

model Complaint {
  id          String          @id @default(cuid())
  bookingId   String          @unique @map("booking_id")
  complainant String // 'student' or 'tutor'
  subject     String
  description String          @db.Text
  status      ComplaintStatus @default(OPEN)
  resolution  String?         @db.Text
  resolvedBy  String?         @map("resolved_by") // staff user ID
  resolvedAt  DateTime?       @map("resolved_at")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("complaints")
}
